From e8ea26f6dff82e9f110369058ae406873165c5a4 Mon Sep 17 00:00:00 2001
From: Xinmudotmoe <xinmu@xinmu.moe>
Date: Thu, 17 Jul 2025 23:48:47 +0800
Subject: [PATCH 1/2] Add riscv support

Signed-off-by: Xinmudotmoe <xinmu@xinmu.moe>
Signed-off-by: Han Gao <rabenda.cn@gmail.com>
---
 CMakeLists.txt                                | 20 ++++++---
 shared/source/helpers/CMakeLists.txt          |  3 --
 shared/source/helpers/riscv64/CMakeLists.txt  | 14 +++++++
 .../source/helpers/riscv64/local_id_gen.cpp   | 36 ++++++++++++++++
 shared/source/utilities/cpuintrinsics.cpp     | 32 ++++++++++++++
 .../utilities/linux/riscv64/CMakeLists.txt    | 14 +++++++
 .../utilities/linux/riscv64/cpu_info.cpp      | 42 +++++++++++++++++++
 .../source/utilities/riscv64/CMakeLists.txt   | 12 ++++++
 .../utilities/riscv64/cpu_info_riscv64.cpp    | 18 ++++++++
 9 files changed, 182 insertions(+), 9 deletions(-)
 create mode 100644 shared/source/helpers/riscv64/CMakeLists.txt
 create mode 100644 shared/source/helpers/riscv64/local_id_gen.cpp
 create mode 100644 shared/source/utilities/linux/riscv64/CMakeLists.txt
 create mode 100644 shared/source/utilities/linux/riscv64/cpu_info.cpp
 create mode 100644 shared/source/utilities/riscv64/CMakeLists.txt
 create mode 100644 shared/source/utilities/riscv64/cpu_info_riscv64.cpp

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 618f67fe82fe..4c0dd617793d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -50,6 +50,11 @@ elseif(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "aarch64")
   endif()
   include_directories(${CMAKE_CURRENT_SOURCE_DIR}/third_party/sse2neon)
   set(DISABLE_WDDM_LINUX TRUE)
+elseif(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "riscv64")
+  set(NEO_TARGET_PROCESSOR "riscv64")
+  set(NEO_DISABLE_LD_LLD TRUE)
+  set(NEO_DISABLE_LD_GOLD TRUE)
+  set(DISABLE_WDDM_LINUX TRUE)
 endif()
 include_directories("${CMAKE_CURRENT_SOURCE_DIR}/shared/source/gmm_helper/igfxfmid_wrapper/${BRANCH_DIR_SUFFIX}")
 include_directories("${CMAKE_CURRENT_SOURCE_DIR}/shared/source/device_binary_format/aot_platforms/${BRANCH_DIR_SUFFIX}")
@@ -143,15 +148,18 @@ if(NOT CMAKE_BUILD_TYPE)
   message(STATUS "CMAKE_BUILD_TYPE not specified, using Release")
   set(CMAKE_BUILD_TYPE "Release" CACHE STRING "Build type: [Release, ReleaseInternal, Debug]" FORCE)
 endif()
-
-if(CMAKE_SIZEOF_VOID_P EQUAL 8)
+if(${CMAKE_SYSTEM_PROCESSOR} STREQUAL "riscv64")
   set(NEO_BITS "64")
-  set(NEO_ARCH "x64")
+  set(NEO_ARCH "riscv64")
 else()
-  set(NEO_BITS "32")
-  set(NEO_ARCH "x86")
+  if(CMAKE_SIZEOF_VOID_P EQUAL 8)
+    set(NEO_BITS "64")
+    set(NEO_ARCH "x64")
+  else()
+    set(NEO_BITS "32")
+    set(NEO_ARCH "x86")
+  endif()
 endif()
-
 if(NOT DEFINED NEO_BUILD_WITH_OCL)
   if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/opencl/CMakeLists.txt)
     set(NEO_BUILD_WITH_OCL TRUE)
diff --git a/shared/source/helpers/CMakeLists.txt b/shared/source/helpers/CMakeLists.txt
index 87f0ce40bef5..d4daf0f0b2f1 100644
--- a/shared/source/helpers/CMakeLists.txt
+++ b/shared/source/helpers/CMakeLists.txt
@@ -112,7 +112,6 @@ set(NEO_CORE_HELPERS
     ${CMAKE_CURRENT_SOURCE_DIR}/local_id_gen.h
     ${CMAKE_CURRENT_SOURCE_DIR}/local_id_gen.inl
     ${CMAKE_CURRENT_SOURCE_DIR}/local_id_gen_special.inl
-    ${CMAKE_CURRENT_SOURCE_DIR}/local_id_gen_sse4.cpp
     ${CMAKE_CURRENT_SOURCE_DIR}/local_work_size.cpp
     ${CMAKE_CURRENT_SOURCE_DIR}/local_work_size.h
     ${CMAKE_CURRENT_SOURCE_DIR}/memory_properties_helpers.cpp
@@ -157,8 +156,6 @@ set(NEO_CORE_HELPERS
     ${CMAKE_CURRENT_SOURCE_DIR}/topology.h
     ${CMAKE_CURRENT_SOURCE_DIR}/topology.cpp
     ${CMAKE_CURRENT_SOURCE_DIR}/topology_map.h
-    ${CMAKE_CURRENT_SOURCE_DIR}/uint16_avx2.h
-    ${CMAKE_CURRENT_SOURCE_DIR}/uint16_sse4.h
     ${CMAKE_CURRENT_SOURCE_DIR}/validators.h
     ${CMAKE_CURRENT_SOURCE_DIR}/vec.h
     ${CMAKE_CURRENT_SOURCE_DIR}/definitions${BRANCH_DIR_SUFFIX}blit_properties_ext.h
diff --git a/shared/source/helpers/riscv64/CMakeLists.txt b/shared/source/helpers/riscv64/CMakeLists.txt
new file mode 100644
index 000000000000..1da2fb2b9cbf
--- /dev/null
+++ b/shared/source/helpers/riscv64/CMakeLists.txt
@@ -0,0 +1,14 @@
+#
+# Copyright (C) 2019-2023 Intel Corporation
+#
+# SPDX-License-Identifier: MIT
+#
+
+if(${NEO_TARGET_PROCESSOR} STREQUAL "riscv64")
+  set(NEO_CORE_HELPERS
+      ${CMAKE_CURRENT_SOURCE_DIR}/CMakeLists.txt
+      ${CMAKE_CURRENT_SOURCE_DIR}/local_id_gen.cpp
+  )
+
+  set_property(GLOBAL APPEND PROPERTY NEO_CORE_HELPERS ${NEO_CORE_HELPERS})
+endif()
diff --git a/shared/source/helpers/riscv64/local_id_gen.cpp b/shared/source/helpers/riscv64/local_id_gen.cpp
new file mode 100644
index 000000000000..3b1c97776d0f
--- /dev/null
+++ b/shared/source/helpers/riscv64/local_id_gen.cpp
@@ -0,0 +1,36 @@
+/*
+ * Copyright (C) 2018-2024 Intel Corporation
+ *
+ * SPDX-License-Identifier: MIT
+ *
+ */
+
+#include "shared/source/helpers/local_id_gen.h"
+
+#include "shared/source/execution_environment/root_device_environment.h"
+#include "shared/source/helpers/aligned_memory.h"
+#include "shared/source/helpers/gfx_core_helper.h"
+#include "shared/source/helpers/local_id_gen_special.inl"
+#include "shared/source/utilities/cpu_info.h"
+
+#include <array>
+
+namespace NEO {
+
+// Initialize the lookup table based on CPU capabilities
+LocalIDHelper::LocalIDHelper() {
+}
+
+LocalIDHelper LocalIDHelper::initializer;
+
+// traditional function to generate local IDs
+void generateLocalIDs(void *buffer, uint16_t simd, const std::array<uint16_t, 3> &localWorkgroupSize, const std::array<uint8_t, 3> &dimensionsOrder, bool isImageOnlyKernel, uint32_t grfSize, uint32_t grfCount, const RootDeviceEnvironment &rootDeviceEnvironment) {
+    bool useLayoutForImages = isImageOnlyKernel && isCompatibleWithLayoutForImages(localWorkgroupSize, dimensionsOrder, simd);
+    if (useLayoutForImages) {
+        generateLocalIDsWithLayoutForImages(buffer, localWorkgroupSize, simd);
+    } else {
+        generateLocalIDsForSimdOne(buffer, localWorkgroupSize, dimensionsOrder, grfSize);
+    }
+}
+
+} // namespace NEO
diff --git a/shared/source/utilities/cpuintrinsics.cpp b/shared/source/utilities/cpuintrinsics.cpp
index 622d76ca314c..30a6370fd40e 100644
--- a/shared/source/utilities/cpuintrinsics.cpp
+++ b/shared/source/utilities/cpuintrinsics.cpp
@@ -14,6 +14,8 @@
 #else
 #if defined(__ARM_ARCH)
 extern "C" uint64_t __rdtsc();
+#elif defined(__riscv) && __riscv_xlen == 64
+// nothing
 #else
 #include <immintrin.h>
 #include <x86intrin.h>
@@ -22,6 +24,8 @@ extern "C" uint64_t __rdtsc();
 
 #if defined(__ARM_ARCH)
 #include <sse2neon.h>
+#elif defined(__riscv) && __riscv_xlen == 64
+// nothing
 #else
 #include <emmintrin.h>
 #endif
@@ -30,27 +34,49 @@ namespace NEO {
 namespace CpuIntrinsics {
 
 void clFlush(void const *ptr) {
+#if !(defined(__riscv) && __riscv_xlen == 64)
     _mm_clflush(ptr);
+#else
+    asm volatile("fence rw,rw");
+#endif
 }
 
 void clFlushOpt(void *ptr) {
 #ifdef SUPPORTS_CLFLUSHOPT
     _mm_clflushopt(ptr);
 #else
+#if !(defined(__riscv) && __riscv_xlen == 64)
     _mm_clflush(ptr);
+#else
+    asm volatile("fence rw,rw");
+#endif
 #endif
 }
 
 void sfence() {
+#if !(defined(__riscv) && __riscv_xlen == 64)
     _mm_sfence();
+#else
+    asm volatile("fence w,w");
+#endif
 }
 
 void mfence() {
+#if !(defined(__riscv) && __riscv_xlen == 64)
     _mm_mfence();
+#else
+    asm volatile("fence rw,rw");
+#endif
 }
 
 void pause() {
+#if !(defined(__riscv) && __riscv_xlen == 64)
     _mm_pause();
+#else
+//    need zihintpause
+//    asm volatile("pause":::"memory");
+    asm volatile(".insn 0x0100000f" ::: "memory");
+#endif
 }
 
 uint8_t tpause(uint32_t control, uint64_t counter) {
@@ -76,7 +102,13 @@ void umonitor(void *a) {
 }
 
 uint64_t rdtsc() {
+#if defined(__riscv) && __riscv_xlen == 64
+    uint64_t val;
+    asm volatile("rdtime %0" : "=r"(val));
+    return val;
+#else
     return __rdtsc();
+#endif
 }
 
 } // namespace CpuIntrinsics
diff --git a/shared/source/utilities/linux/riscv64/CMakeLists.txt b/shared/source/utilities/linux/riscv64/CMakeLists.txt
new file mode 100644
index 000000000000..66ab98ffa020
--- /dev/null
+++ b/shared/source/utilities/linux/riscv64/CMakeLists.txt
@@ -0,0 +1,14 @@
+#
+# Copyright (C) 2019-2021 Intel Corporation
+#
+# SPDX-License-Identifier: MIT
+#
+
+if(${NEO_TARGET_PROCESSOR} STREQUAL "riscv64")
+  list(APPEND NEO_CORE_UTILITIES_LINUX
+       ${CMAKE_CURRENT_SOURCE_DIR}/CMakeLists.txt
+       ${CMAKE_CURRENT_SOURCE_DIR}/cpu_info.cpp
+  )
+
+  set_property(GLOBAL PROPERTY NEO_CORE_UTILITIES_LINUX ${NEO_CORE_UTILITIES_LINUX})
+endif()
diff --git a/shared/source/utilities/linux/riscv64/cpu_info.cpp b/shared/source/utilities/linux/riscv64/cpu_info.cpp
new file mode 100644
index 000000000000..044c1b50b8f0
--- /dev/null
+++ b/shared/source/utilities/linux/riscv64/cpu_info.cpp
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2019-2022 Intel Corporation
+ *
+ * SPDX-License-Identifier: MIT
+ *
+ */
+
+#include "shared/source/utilities/cpu_info.h"
+
+#include "shared/source/os_interface/linux/os_inc.h"
+
+#include <fstream>
+
+namespace NEO {
+
+void cpuidLinuxWrapper(int cpuInfo[4], int functionId) {
+}
+
+void cpuidexLinuxWrapper(int *cpuInfo, int functionId, int subfunctionId) {
+}
+
+void getCpuFlagsLinux(std::string &cpuFlags) {
+}
+
+void (*CpuInfo::cpuidexFunc)(int *, int, int) = cpuidexLinuxWrapper;
+void (*CpuInfo::cpuidFunc)(int[4], int) = cpuidLinuxWrapper;
+void (*CpuInfo::getCpuFlagsFunc)(std::string &) = getCpuFlagsLinux;
+
+const CpuInfo CpuInfo::instance;
+
+void CpuInfo::cpuid(
+    uint32_t cpuInfo[4],
+    uint32_t functionId) const {
+}
+
+void CpuInfo::cpuidex(
+    uint32_t cpuInfo[4],
+    uint32_t functionId,
+    uint32_t subfunctionId) const {
+}
+
+} // namespace NEO
diff --git a/shared/source/utilities/riscv64/CMakeLists.txt b/shared/source/utilities/riscv64/CMakeLists.txt
new file mode 100644
index 000000000000..413ca2f0e670
--- /dev/null
+++ b/shared/source/utilities/riscv64/CMakeLists.txt
@@ -0,0 +1,12 @@
+#
+# Copyright (C) 2021 Intel Corporation
+#
+# SPDX-License-Identifier: MIT
+#
+
+if(${NEO_TARGET_PROCESSOR} STREQUAL "riscv64")
+  set_property(GLOBAL APPEND PROPERTY NEO_CORE_UTILITIES
+               ${CMAKE_CURRENT_SOURCE_DIR}/CMakeLists.txt
+               ${CMAKE_CURRENT_SOURCE_DIR}/cpu_info_riscv64.cpp
+  )
+endif()
diff --git a/shared/source/utilities/riscv64/cpu_info_riscv64.cpp b/shared/source/utilities/riscv64/cpu_info_riscv64.cpp
new file mode 100644
index 000000000000..754a8025c34b
--- /dev/null
+++ b/shared/source/utilities/riscv64/cpu_info_riscv64.cpp
@@ -0,0 +1,18 @@
+/*
+ * Copyright (C) 2021-2024 Intel Corporation
+ *
+ * SPDX-License-Identifier: MIT
+ *
+ */
+
+#include "shared/source/debug_settings/debug_settings_manager.h"
+#include "shared/source/utilities/cpu_info.h"
+
+#ifndef BIT
+#define BIT(x) (1ull << (x))
+#endif
+
+namespace NEO {
+void CpuInfo::detect() const {
+}
+} // namespace NEO
-- 
2.47.3

